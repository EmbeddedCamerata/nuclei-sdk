TARGET_ELF = $(TARGET).elf

ALL_CSRCS = $(sort $(C_SRCS) $(call get_csrcs, $(SRCDIRS) $(C_SRCDIRS)))
ALL_CXXSRCS = $(sort $(CXX_SRCS) $(call get_cxxsrcs, $(SRCDIRS) $(CXX_SRCDIRS)))
ALL_ASMSRCS = $(sort $(ASM_SRCS) $(call get_asmsrcs, $(SRCDIRS) $(ASM_SRCDIRS)))

ALL_ASM_OBJS := $(ALL_ASMSRCS:=.o)
ALL_C_OBJS := $(ALL_CSRCS:=.o)
ALL_CXX_OBJS := $(ALL_CXXSRCS:=.o)

ALL_OBJS += $(ALL_ASM_OBJS) $(ALL_C_OBJS) $(ALL_CXX_OBJS)

ALL_DEPS := $(ALL_OBJS:=.d)

CLEAN_OBJS += $(TARGET).elf $(TARGET).map $(TARGET).dump $(TARGET).verilog $(ALL_OBJS) $(ALL_DEPS)
REAL_CLEAN_OBJS = $(subst /,$(PS), $(CLEAN_OBJS))

# include dependency files of application
ifneq ($(MAKECMDGOALS),clean)
 -include $(ALL_DEPS)
endif

.PHONY: all

help:
	@$(ECHO) "Nuclei N/NX-series RISC-V Embedded Processor Software Development Kit "
	@$(ECHO) "== How to Use with Make =="
	@$(ECHO) "1. Build Application:"
	@$(ECHO) "all [PROGRAM=flash/flashxip/ilm]"
	@$(ECHO) "   Build a software program to load with the debugger."
	@$(ECHO) "2. Upload Application to Board using OpenOCD:"
	@$(ECHO) "upload [PROGRAM=flash/flashxip/ilm]"
	@$(ECHO) "   Launch OpenOCD to flash your program to the on-board Flash."
	@$(ECHO) "3: Debug Application using OpenOCD"
	@$(ECHO) "  3.1: run_openocd"
	@$(ECHO) "  3.2: run_gdb [PROGRAM=flash/flashxip/ilm]"
	@$(ECHO) "   Step 1: Launch OpenOCD for Debugger connection: make run_openocd"
	@$(ECHO) "   Step 2: Launch GDB to connect openocd server, you need to run load"
	@$(ECHO) "           your code, and set breakpoints using gdb and debug it."
	@$(ECHO) "           Allows Ctrl-C to halt running programs."
	@$(ECHO) ""
	@$(ECHO) "== Example Usage =="
	@$(ECHO) "1. cd $NUCLEI_SDK_ROOT/application/helloworld"
	@$(ECHO) "2. Build for ILM download mode: make DOWNLOAD=ilm all"
	@$(ECHO) "3. Download application to board: make DOWNLOAD=ilm upload"
	@$(ECHO) "4. Debug application using OpenOCD:"
	@$(ECHO) "   4.1 Terminal One: make DOWNLOAD=ilm run_openocd"
	@$(ECHO) "   4.2 Terminal Two: make DOWNLOAD=ilm run_gdb"
	@$(ECHO) ""

all: $(TARGET).elf

$(TARGET).elf: $(ALL_OBJS)
	$(TRACE_LINK)
	$(Q)$(CC) $(CFLAGS) $(ALL_OBJS) -o $@ $(LDFLAGS)
	$(Q)$(SIZE) $@

$(ALL_ASM_OBJS): %.o: % $(COMMON_PREREQS)
	$(TRACE_ASSEMBLE)
	$(Q)$(CC) $(ASMFLAGS) -c -o $@ $<

$(ALL_C_OBJS): %.o: % $(COMMON_PREREQS)
	$(TRACE_COMPILE)
	$(Q)$(CC) $(CFLAGS) -c -o $@ $<

$(ALL_CXX_OBJS): %.o: % $(COMMON_PREREQS)
	$(TRACE_COMPILE)
	$(Q)$(CXX) $(CXXFLAGS) -c -o $@ $<

dasm: $(TARGET).elf
	$(OBJDUMP) -S -D $< > $(TARGET).dump
	$(OBJCOPY) $< -O verilog $(TARGET).verilog
	sed -i 's/@800/@000/g' $(TARGET).verilog

upload: $(TARGET).elf
	$(OPENOCD) $(OPENOCD_ARGS) & \
		$(GDB) $< $(GDB_UPLOAD_ARGS) $(GDB_UPLOAD_CMDS) && \
	echo "Successfully uploaded $< "

run_openocd:
	$(OPENOCD) $(OPENOCD_ARGS)

run_gdb: $(TARGET).elf
	$(GDB) $< $(GDB_ARGS) $(GDB_CMDS)

clean:
	$(RM) $(REAL_CLEAN_OBJS)
